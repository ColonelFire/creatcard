<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Générateur TCG – joints corrigés</title>
<style>
  :root{ --bg:#8C8C8C; --ui:#0b3890; --ui2:#0f44a9; --text:#ECF2FF; --shadow: rgba(0,0,0,.35); }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
  header{background:var(--ui2);padding:10px 16px;font-weight:700}
  .app{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px;min-height:0;flex:1}
  .panel{background:var(--ui);padding:12px;border-radius:12px;box-shadow:0 8px 30px var(--shadow);overflow:auto}
  .panel h2{margin:0 0 10px 0;font-size:18px}
  .group{margin-bottom:12px}
  .group label{display:block;font-size:12px;margin:0 0 6px 2px;opacity:.9}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:#0a2e73;color:var(--text);
    padding:10px;font-size:14px;outline:none
  }
  textarea{min-height:84px;resize:vertical}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{border:0;background:#173b97;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  button.secondary{background:#0a2e73}
  .preview{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    border-radius:12px;box-shadow:0 8px 30px var(--shadow);position:relative}
  canvas{display:block;max-width:100%;height:auto;box-shadow:0 18px 50px var(--shadow);background:#fff}
  .foot{opacity:.8;margin-top:8px;font-size:12px}
</style>
</head>
<body>
<header>Générateur de cartes TCG – 63 × 89 mm (300 DPI)</header>
<div class="app">
  <div class="panel">
    <h2>Paramètres</h2>

    <div class="group">
      <div class="row">
        <div>
          <label for="cadre">Cadre</label>
          <select id="cadre">
            <option value="noir">Noir (#0D0D0D)</option>
            <option value="invisible">Invisible</option>
          </select>
        </div>
        <div>
          <label for="rarete">Rareté</label>
          <select id="rarete">
            <option value="1">Commun</option>
            <option value="2">Peu Commune</option>
            <option value="3">Rare</option>
            <option value="4">Epic</option>
            <option value="5">Légendaire</option>
            <option value="6">Exclusif</option>
          </select>
        </div>
      </div>
    </div>

    <div class="group">
      <label for="nom">Nom (14 pt)</label>
      <input id="nom" type="text" placeholder="Nom de la créature" />
    </div>

    <div class="group row">
      <div>
        <label for="pv">PV (10 pt)</label>
        <input id="pv" type="text" placeholder="120" />
      </div>
      <div>
        <label for="extension">Extension (10 pt)</label>
        <input id="extension" type="text" placeholder="CL01" />
      </div>
    </div>

    <div class="group row">
      <div>
        <label for="illustrateur">Illustrateur (6 pt)</label>
        <input id="illustrateur" type="text" placeholder="Nom de l’illustrateur" />
      </div>
      <div>
        <label for="numero">Numéro (6 pt)</label>
        <input id="numero" type="text" placeholder="002/112" />
      </div>
    </div>

    <div class="group">
      <label for="description">Description & Attaque (10 pt)</label>
      <textarea id="description" placeholder="Texte de description et attaque…"></textarea>
    </div>

    <div class="group">
      <label>Statistiques (8 pt)</label>
      <div class="row">
        <div>
          <label for="atk">Attaque</label>
          <input id="atk" type="number" placeholder="31" />
        </div>
        <div>
          <label for="def">Défense</label>
          <input id="def" type="number" placeholder="30" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="atkspd">Vit.Attaque</label>
          <input id="atkspd" type="number" placeholder="34" />
        </div>
        <div>
          <label for="defspd">Vit.Défense</label>
          <input id="defspd" type="number" placeholder="33" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="spd">Vitesse (bas de carte)</label>
          <input id="spd" type="number" placeholder="20" />
        </div>
      </div>
    </div>

    <div class="group">
      <label>Hexagone d'évolution (1 cm, image interne)</label>
      <div class="btns">
        <label style="display:flex;align-items:center;gap:6px;margin-right:auto;">
          <input id="hexOn" type="checkbox" checked> Afficher l'hexagone
        </label>
        <input id="hexFile" type="file" accept="image/*">
        <button id="clearHex" class="secondary">Effacer image (hexagone)</button>
      </div>
      <div style="margin-top:8px">
        <label for="hexZoom">Hex : Zoom</label>
        <input id="hexZoom" type="range" min="0.2" max="2.5" step="0.01" value="1"> <span id="hexZoomVal">100%</span>
      </div>
    </div>

    <div class="group">
      <label>Image (arrière-plan)</label>
      <div class="btns">
        <input type="file" id="file" accept="image/*" />
        <button id="resetImg" class="secondary">Réinitialiser l’image</button>
        <button id="clearBg" class="secondary">Effacer image (arrière-plan)</button>
      </div>
      <div class="row" style="align-items:center;margin-top:8px">
        <div>
          <label for="zoom">Zoom image</label>
          <input id="zoom" type="range" min="0.2" max="3" step="0.01" value="1">
        </div>
        <div>
          <label for="zoneScale">Zoom texture zone</label>
          <input id="zoneScale" type="range" min="0.25" max="3" step="0.01" value="1">
        </div>
      </div>
      <div class="row" style="font-size:12px;opacity:.85">
        <div><span id="zoomVal">100%</span></div>
        <div><span id="zoneScaleVal">100%</span></div>
      </div>
    </div>

    <div class="group btns">
      <button id="export">Télécharger PNG (300 DPI)</button>
      <button id="clear" class="secondary">Effacer tout</button>
    </div>

    <div class="foot">Icônes rareté: <code>images/C.png</code>, <code>PC.png</code>, <code>R.png</code>, <code>EP.png</code>, <code>L.png</code>, <code>EX.png</code>.  
    Textures: <code>images/1.png</code>…<code>images/6.png</code>.</div>
  </div>

  <div class="preview">
    <canvas id="card" width="744" height="1051"></canvas>
  </div>
</div>

<script>
/* ==== Constantes géométrie ==== */
const DPI=300, MM=DPI/25.4;
const CARD_W=Math.round(63*MM), CARD_H=Math.round(89*MM);
const BORDER=2.5*MM, BOX_W=10*MM, BOX_H=7*MM, NOTCH_SIDE=6*MM, NOTCH_TOP=3*MM, BLUE_H=30*MM;

/* Couleurs */
const COLORS={
  cadre:{ noir:'#0D0D0D', invisible:null },
  zone:{1:'#93BF34',2:'#F2AE30',3:'#F25430',4:'#F23030',5:'#F26398',6:'#04BF8A'},
  coins:'#0D0D0D'
};

/* Textures de zone (optionnelles) */
const zoneTex={};
for(let i=1;i<=6;i++){ const im=new Image(); im.src='images/'+i+'.png'; im.onload=()=>draw(); zoneTex[i]=im; }

/* Icônes de rareté — PRELOAD */
const ICON_FILES={1:'C.png',2:'PC.png',3:'R.png',4:'EP.png',5:'L.png',6:'EX.png'};
const rarityIcons={};
Object.keys(ICON_FILES).forEach(k=>{ const im=new Image(); im.src='images/'+ICON_FILES[k]; im.onload=()=>draw(); rarityIcons[k]=im; });

/* ==== Canvas ==== */
const $=id=>document.getElementById(id), pt=v=>v*DPI/72;
const c=$('card'), ctx=c.getContext('2d'); c.width=CARD_W; c.height=CARD_H;
function setPreviewSize(){ const container=document.querySelector('.preview'); const maxW=Math.min(372,(container?container.clientWidth:372)-20); const cssW=Math.max(240,maxW); c.style.width=cssW+'px'; c.style.height=(cssW*89/63)+'px'; }
window.addEventListener('resize', setPreviewSize);

/* État images */
let img=null, imgPos={x:CARD_W/2,y:CARD_H/2}, imgScale=1;
let hexImg=null, hexScale=1, hexPos=null, hexImgOffset={x:0,y:0};
let zoneScale=1;

/* DOM */
const inputs={
  cadre:$('cadre'), rarete:$('rarete'), nom:$('nom'), pv:$('pv'), extension:$('extension'),
  illustrateur:$('illustrateur'), numero:$('numero'), description:$('description'),
  atk:$('atk'), atkspd:$('atkspd'), def:$('def'), defspd:$('defspd'), spd:$('spd'),
  file:$('file'), zoom:$('zoom'), zoomVal:$('zoomVal'), export:$('export'), clear:$('clear'), resetImg:$('resetImg'),
  clearBg:$('clearBg'),
  hexOn:$('hexOn'), hexFile:$('hexFile'), hexZoom:$('hexZoom'), hexZoomVal:$('hexZoomVal'),
  clearHex:$('clearHex'),
  zoneScale:$('zoneScale'), zoneScaleVal:$('zoneScaleVal')
};

function loadImage(file){ const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.onload=()=>{ img=i; imgScale=1; imgPos={x:CARD_W/2,y:CARD_H/2}; draw(); }; i.src=e.target.result; }; r.readAsDataURL(file); }
inputs.file.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]) loadImage(e.target.files[0]); });

inputs.resetImg.addEventListener('click', ()=>{ imgScale=1; imgPos={x:CARD_W/2,y:CARD_H/2}; inputs.zoom.value='1'; inputs.zoomVal.textContent='100%'; draw(); });
inputs.clearBg.addEventListener('click', ()=>{ img=null; inputs.file.value=''; imgScale=1; imgPos={x:CARD_W/2,y:CARD_H/2}; inputs.zoom.value='1'; inputs.zoomVal.textContent='100%'; draw(); });

inputs.zoom.addEventListener('input', ()=>{ imgScale=parseFloat(inputs.zoom.value); inputs.zoomVal.textContent=Math.round(imgScale*100)+'%'; draw(); });
inputs.zoneScale.addEventListener('input', ()=>{ zoneScale=parseFloat(inputs.zoneScale.value); inputs.zoneScaleVal.textContent=Math.round(zoneScale*100)+'%'; draw(); });

inputs.hexFile.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]){ const R=new FileReader(); R.onload=ev=>{ const i=new Image(); i.onload=()=>{ hexImg=i; draw(); }; i.src=ev.target.result; }; R.readAsDataURL(e.target.files[0]); } });
inputs.hexZoom.addEventListener('input', ()=>{ hexScale=parseFloat(inputs.hexZoom.value); inputs.hexZoomVal.textContent=Math.round(hexScale*100)+'%'; draw(); });
inputs.clearHex.addEventListener('click', ()=>{ hexImg=null; inputs.hexFile.value=''; hexScale=1; hexImgOffset={x:0,y:0}; inputs.hexZoom.value='1'; inputs.hexZoomVal.textContent='100%'; draw(); });

/* Drag/zoom ciblés */
let dragging=false, dragStart={x:0,y:0}, startPos={x:0,y:0}, startHexOffset={x:0,y:0}, dragTarget='mainimg';
c.addEventListener('pointerdown', e=>{
  const rect=c.getBoundingClientRect(); const s=c.width/rect.width; const px=(e.clientX-rect.left)*s, py=(e.clientY-rect.top)*s;
  dragging=true; dragStart={x:px,y:py}; startPos={...imgPos}; startHexOffset={...hexImgOffset};
  const innerX=BORDER, innerY=BORDER, innerW=CARD_W-2*BORDER, innerH=CARD_H-2*BORDER; const zoneY=innerY+innerH-BLUE_H;
  if(!hexPos){ const d=10*MM; hexPos={x:innerX+d/2+1*MM, y:zoneY-d/2-1*MM}; }
  let inside=false; if(inputs.hexOn.checked){ const r=(10*MM)/2; const dx=px-hexPos.x, dy=py-hexPos.y; inside=(dx*dx+dy*dy)<=r*r; }
  dragTarget = inside ? 'heximg' : 'mainimg';
  c.setPointerCapture(e.pointerId);
});
c.addEventListener('pointermove', e=>{
  if(!dragging) return; const rect=c.getBoundingClientRect(); const s=c.width/rect.width; const px=(e.clientX-rect.left)*s, py=(e.clientY-rect.top)*s;
  const dx=px-dragStart.x, dy=py-dragStart.y;
  if(dragTarget==='heximg'){ hexImgOffset={x:startHexOffset.x+dx,y:startHexOffset.y+dy}; }
  else { if(!img) return; imgPos={x:startPos.x+dx,y:startPos.y+dy}; }
  draw();
});
c.addEventListener('pointerup', e=>{ dragging=false; try{c.releasePointerCapture(e.pointerId);}catch(_){} });
c.addEventListener('wheel', e=>{
  e.preventDefault(); const rect=c.getBoundingClientRect(); const s=c.width/rect.width; const px=(e.clientX-rect.left)*s, py=(e.clientY-rect.top)*s;
  const delta=-e.deltaY/1000;
  let inside=false; if(hexPos){ const r=(10*MM)/2; const dx=px-hexPos.x, dy=py-hexPos.y; inside=(dx*dx+dy*dy)<=r*r; }
  if(inside){ hexScale=Math.min(2.5,Math.max(0.2,hexScale*(1+delta))); inputs.hexZoom.value=hexScale.toFixed(2); inputs.hexZoomVal.textContent=Math.round(hexScale*100)+'%'; }
  else { if(!img) return; imgScale=Math.min(3,Math.max(0.2,imgScale*(1+delta))); inputs.zoom.value=imgScale.toFixed(2); inputs.zoomVal.textContent=Math.round(imgScale*100)+'%'; }
  draw();
},{passive:false});

inputs.export.addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='carte_tcg_'+Date.now()+'.png'; a.click(); });
inputs.clear.addEventListener('click', ()=>{
  ['nom','pv','extension','illustrateur','numero','description','atk','atkspd','def','defspd','spd'].forEach(id=>$(id).value='');
  inputs.rarete.value='1'; inputs.cadre.value='noir';
  img=null; inputs.file.value=''; imgScale=1; imgPos={x:CARD_W/2,y:CARD_H/2};
  hexImg=null; inputs.hexFile.value=''; hexScale=1; hexImgOffset={x:0,y:0};
  zoneScale=1; inputs.zoneScale.value='1'; inputs.zoneScaleVal.textContent='100%';
  inputs.zoom.value='1'; inputs.zoomVal.textContent='100%';
  inputs.hexZoom.value='1'; inputs.hexZoomVal.textContent='100%';
  draw();
});
['input','change'].forEach(evt=>{
  ['cadre','rarete','nom','pv','extension','illustrateur','numero','description','atk','atkspd','def','defspd','spd','hexOn']
    .forEach(id=>$(id).addEventListener(evt, draw));
});

/* ================= Helpers cadre (anti-jours) ================= */

// Aligne sur des pixels entiers et élargit d’un cheveu
function fillCrispRect(x, y, w, h){
  const ax = Math.floor(x);
  const ay = Math.floor(y);
  const aw = Math.ceil(x + w) - ax;
  const ah = Math.ceil(y + h) - ay;
  ctx.fillRect(ax, ay, aw, ah);
}

// Cadre plein peint d’abord, puis “découpé” en blanc à l’intérieur
function drawFrame(style){
  if(!style) return;
  ctx.save();
  ctx.fillStyle = style;
  ctx.fillRect(0, 0, CARD_W, CARD_H); // aucun joint visible

  ctx.fillStyle = '#fff';
  fillCrispRect(BORDER, BORDER, CARD_W - 2*BORDER, CARD_H - 2*BORDER);
  ctx.restore();
}

// Barre horizontale : déborde légèrement pour couvrir les côtés
function drawHorizontalBar(style, y){
  if(!style) return;
  ctx.fillStyle = style;
  fillCrispRect(BORDER - 1, y - BORDER, (CARD_W - 2*BORDER) + 2, BORDER + 1);
}

// Compartiment gauche (léger débord pour cacher tout joint)
function compartmentLeft(x, y, w, h, notchX, notchY, style){
  const f = 1;
  x -= f; w += f;
  ctx.beginPath();
  ctx.moveTo(Math.floor(x), Math.floor(y));
  ctx.lineTo(Math.ceil(x + w), Math.floor(y));
  ctx.lineTo(Math.ceil(x + w), Math.ceil(y + h - notchY));
  ctx.lineTo(Math.ceil(x + w - notchX), Math.ceil(y + h));
  ctx.lineTo(Math.floor(x), Math.ceil(y + h));
  ctx.closePath();
  ctx.fillStyle = style;
  ctx.fill();
}

// Compartiment droit (léger débord pour cacher tout joint)
function compartmentRight(x, y, w, h, notchX, notchY, style){
  const f = 1;
  x -= f; w += f;
  ctx.beginPath();
  ctx.moveTo(Math.floor(x), Math.floor(y));
  ctx.lineTo(Math.ceil(x + w), Math.floor(y));
  ctx.lineTo(Math.ceil(x + w), Math.ceil(y + h));
  ctx.lineTo(Math.ceil(x + notchX), Math.ceil(y + h));
  ctx.lineTo(Math.floor(x), Math.ceil(y + h - notchY));
  ctx.closePath();
  ctx.fillStyle = style;
  ctx.fill();
}

/* Zone texture (cover, ancrée bas) */
function drawZoneTextureClipped(img,x,y,w,h,alpha,scale){
  ctx.save(); ctx.beginPath(); ctx.rect(x,y,w,h); ctx.clip(); ctx.globalAlpha = alpha;
  if(img && img.complete && img.naturalWidth){
    const s = Math.max(w/img.width, h/img.height) * (scale||1);
    const dw = img.width*s, dh = img.height*s;
    const dx = x + (w - dw)/2, dy = y + h - dh; // ancré en bas
    ctx.drawImage(img, dx, dy, dw, dh);
  } else { ctx.fillStyle='#ccc'; ctx.fillRect(x,y,w,h); }
  ctx.restore();
}

/* ================== Rendu principal ================== */
function draw(){
  ctx.clearRect(0,0,CARD_W,CARD_H);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,CARD_W,CARD_H);

  // image principale
  if(img){
    const cover=Math.max(CARD_W/img.width, CARD_H/img.height);
    const s=cover*imgScale; const w=img.width*s, h=img.height*s;
    ctx.drawImage(img, imgPos.x-w/2, imgPos.y-h/2, w, h);
  }

  const r=parseInt(inputs.rarete.value,10);
  const userCadre = inputs.cadre.value;
  const cadreSel  = (r<=3) ? 'noir' : userCadre;      // 1–3 forcé noir

  inputs.cadre.disabled = (r<=3);
  if(r<=3 && inputs.cadre.value!=='noir') inputs.cadre.value='noir';

  const cadreStyle = (cadreSel==='noir') ? '#0D0D0D' : null;

  // cadre
  drawFrame(cadreStyle);

  // compartiments (noirs si cadre invisible)
  const innerX=BORDER, innerY=BORDER, innerW=CARD_W-2*BORDER, innerH=CARD_H-2*BORDER;
  const compStyle = (cadreStyle || '#0D0D0D');
  const boxY=innerY, leftBoxX=innerX, rightBoxX=innerX+innerW-BOX_W;
  compartmentLeft(leftBoxX, boxY, BOX_W, BOX_H, NOTCH_SIDE, NOTCH_TOP, compStyle);
  compartmentRight(rightBoxX, boxY, BOX_W, BOX_H, NOTCH_SIDE, NOTCH_TOP, compStyle);
  ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`${pt(10)}px sans-serif`;
  ctx.fillText((inputs.extension.value||'').trim(), leftBoxX+BOX_W/2, boxY+BOX_H/2);
  ctx.fillText((inputs.pv.value||'').trim(),       rightBoxX+BOX_W/2, boxY+BOX_H/2);

  // coins L : r>=4 et cadre visible
  if(r>=4 && cadreSel!=='invisible'){
    const t=BORDER; ctx.fillStyle=COLORS.coins;
    fillCrispRect(0,0,t*4,t); fillCrispRect(0,0,t,t*4);
    fillCrispRect(CARD_W-t*4,0,t*4,t); fillCrispRect(CARD_W-t,0,t,t*4);
  }

  // zone rareté
  const zoneX=innerX, zoneW=innerW, zoneH=BLUE_H, zoneY=innerY+innerH-zoneH;
  const alpha = (r>=4 ? 0.85 : 1);
  const zImg = zoneTex[r];
  if(zImg && zImg.complete && zImg.naturalWidth){ drawZoneTextureClipped(zImg, zoneX, zoneY, zoneW, zoneH, alpha, zoneScale); }
  else { ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=COLORS.zone[r]; fillCrispRect(zoneX, zoneY, zoneW, zoneH); ctx.restore(); }

  // barre horizontale si cadre visible
  if(cadreSel!=='invisible'){ drawHorizontalBar('#0D0D0D', zoneY); }

  // hexagone — toujours noir
  if(inputs.hexOn.checked){
    if(!hexPos){ const d=10*MM; hexPos={x:innerX + d/2 + 1*MM, y: zoneY - d/2 - 1*MM}; }
    const d=10*MM, rr=d/2, pts=[]; for(let i=0;i<6;i++){ const ang=Math.PI/6 + i*Math.PI/3; pts.push({x:hexPos.x+rr*Math.cos(ang), y:hexPos.y+rr*Math.sin(ang)}); }
    ctx.save(); ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<6;i++) ctx.lineTo(pts[i].x,pts[i].y); ctx.closePath();
    ctx.fillStyle='#fff'; ctx.fill(); ctx.lineWidth=1*MM; ctx.strokeStyle='#0D0D0D'; ctx.stroke();
    if(hexImg && hexImg.complete && hexImg.naturalWidth){
      ctx.save(); ctx.clip();
      const box=d*0.8*hexScale; const ix=hexPos.x-box/2+hexImgOffset.x, iy=hexPos.y-box/2+hexImgOffset.y;
      ctx.drawImage(hexImg, ix, iy, box, box);
      ctx.restore();
    }
    ctx.restore();
  }

  /* ======== TEXTES – STATS FIXES ======== */
  const pad = 2*MM;

  const titleY = zoneY + pad;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillStyle = '#0D0D0D';
  ctx.font = `700 ${pt(14)}px sans-serif`;
  ctx.fillText((inputs.nom.value || '').toUpperCase(), innerX + innerW/2, titleY);

  const descTop = titleY + pt(14) + 1*MM;
  ctx.font = `${pt(10)}px sans-serif`;
  const maxW = innerW - pad*2;
  const raw = (inputs.description.value || '').trim();
  const words = raw.length ? raw.split(/\s+/) : [];
  const lines = [];
  let line = '';
  for (const w of words) {
    const test = line ? line + ' ' + w : w;
    if (ctx.measureText(test).width > maxW && line) { lines.push(line); line = w; }
    else { line = test; }
  }
  if (line) lines.push(line);
  const maxLines = 2;
  for (let i = 0; i < Math.min(lines.length, maxLines); i++) {
    const txt = (i === maxLines - 1 && lines.length > maxLines) ? (lines[i] + '…') : lines[i];
    ctx.fillText(txt, innerX + innerW/2, descTop + i * pt(10) * 1.25);
  }

  const statsTop = descTop + maxLines * pt(10) * 1.25 + 2*MM;
  ctx.font = `${pt(8)}px sans-serif`;
  ctx.fillStyle = '#0D0D0D';
  ctx.textAlign = 'left';
  ctx.fillText(`Attaque : ${(inputs.atk.value || '')}`,        innerX + pad, statsTop);
  ctx.fillText(`Vit.Attaque : ${(inputs.atkspd.value || '')}`, innerX + pad, statsTop + pt(8) * 1.25);
  ctx.textAlign = 'right';
  ctx.fillText(`Défense : ${(inputs.def.value || '')}`,        innerX + innerW - pad, statsTop);
  ctx.fillText(`Vit.Défense : ${(inputs.defspd.value || '')}`, innerX + innerW - pad, statsTop + pt(8) * 1.25);

  // Bas : illu / icône PNG / numéro / vitesse
  const m=1*MM; ctx.textBaseline='alphabetic';
  ctx.textAlign='left'; ctx.font=`${pt(6)}px sans-serif`; ctx.fillText((inputs.illustrateur.value||'').trim(), BORDER+m, CARD_H-BORDER-m);

  const icon=rarityIcons[r], iconSize=pt(6), gap=4; let numX=CARD_W-BORDER-m;
  if(icon && icon.complete && icon.naturalWidth){ const ix=CARD_W-BORDER-m-iconSize, iy=CARD_H-BORDER-m-iconSize+pt(6)*0.25; ctx.drawImage(icon, ix, iy, iconSize, iconSize); numX = ix - gap; }
  else { const ix=CARD_W-BORDER-m-iconSize, iy=CARD_H-BORDER-m-iconSize+pt(6)*0.25; ctx.save(); ctx.fillStyle='#fff'; ctx.fillRect(ix,iy,iconSize,iconSize); ctx.strokeStyle='#00000055'; ctx.strokeRect(ix,iy,iconSize,iconSize); ctx.fillStyle='#0D0D0D'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`bold ${pt(8)}px sans-serif`; ctx.fillText({1:'C',2:'PC',3:'R',4:'EP',5:'L',6:'EX'}[r]||'C', ix+iconSize/2, iy+iconSize/2); ctx.restore(); numX = ix - gap; }
  ctx.textAlign='right'; ctx.font=`${pt(6)}px sans-serif`; ctx.fillText((inputs.numero.value||'').trim(), numX, CARD_H-BORDER-m);

  const spd=(inputs.spd.value||''); if(spd){ ctx.textAlign='center'; ctx.font=`${pt(8)}px sans-serif`; ctx.fillText(`Vitesse : ${spd}`, CARD_W/2, CARD_H-BORDER-m); }
}

/* Boot */
function boot(){ setPreviewSize(); draw(); }
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
</script>
</body>
</html>
